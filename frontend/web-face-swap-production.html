<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwapInterCam - Face Swap Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: white;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
        }

        .panel h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 2px dashed #667eea;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
        }

        .upload-area:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .status {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üé≠ SwapInterCam Face Swap Studio</h1>
        <p>Professional AI-Powered Face Swapping</p>
    </div>

    <div class="container">
        <div class="feature-grid">
            <div class="panel">
                <h3>üìπ Live Camera Feed</h3>
                <div style="background: #333; border-radius: 8px; padding: 20px; text-align: center;">
                    <video id="camera-feed" width="100%" height="200" style="border-radius: 8px; background: #000;"
                        autoplay muted></video>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="startCamera()">üìπ Start Camera</button>
                        <button class="btn" onclick="stopCamera()">‚èπÔ∏è Stop Camera</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>üé≠ Target Face (Reference)</h3>
                <div class="upload-area" onclick="document.getElementById('target-upload').click()">
                    <p>Click to upload target face image</p>
                    <p style="opacity: 0.7; font-size: 0.9rem;">This face will be swapped onto the live video</p>
                </div>
                <input type="file" id="target-upload" style="display: none;" accept="image/*">
                <div id="target-preview"></div>
            </div>
        </div>

        <div class="status">
            <h3>üîÑ Processing Status</h3>
            <div id="status-display">Ready to process face swap</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="startFaceSwap()">üé≠ Start Real-Time Face Swap</button>
            <button class="btn" onclick="stopFaceSwap()">‚èπÔ∏è Stop Face Swap</button>
            <button class="btn" onclick="resetAll()">üîÑ Reset</button>
        </div>

        <div class="panel">
            <h3>‚ú® Live Face Swap Output</h3>
            <div id="result-container" style="text-align: center; padding: 20px;">
                <canvas id="output-canvas" width="640" height="480"
                    style="border-radius: 8px; background: #000; max-width: 100%;"></canvas>
                <p style="opacity: 0.7; margin-top: 10px;">Real-time face swap will appear here</p>
            </div>
        </div>
    </div>

    <script>
        console.log('üé≠ Real-Time Face Swap Studio Loading...');

        let cameraStream = null;
        let targetFaceImage = null;
        let targetFaceImg = null; // Image object for blending
        let faceSwapActive = false;
        let animationFrame = null;
        let faceDetectionEnabled = false;

        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('output-canvas');
        const ctx = canvas.getContext('2d');

        // Face detection variables
        let detectedFaces = [];
        let faceDetectionWorker = null;

        // Target face upload handler
        document.getElementById('target-upload').addEventListener('change', function (e) {
            handleImageUpload(e.target.files[0], 'target');
        });

        // Camera functions
        async function startCamera() {
            try {
                updateStatus('üìπ Starting camera...');
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = cameraStream;
                updateStatus('‚úÖ Camera started successfully');
            } catch (error) {
                console.error('Camera error:', error);
                updateStatus('‚ùå Camera access denied or not available');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                video.srcObject = null;
                updateStatus('‚èπÔ∏è Camera stopped');
            }
        }

        function handleImageUpload(file, type) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.marginTop = '10px';
                img.style.borderRadius = '6px';

                if (type === 'target') {
                    targetFaceImage = e.target.result;

                    // Create image object for face swapping
                    targetFaceImg = new Image();
                    targetFaceImg.onload = function () {
                        updateStatus('üé≠ Target face processed - ready for face swap');
                        initializeFaceDetection();
                    };
                    targetFaceImg.src = e.target.result;

                    document.getElementById('target-preview').innerHTML = '';
                    document.getElementById('target-preview').appendChild(img);
                }
            };
            reader.readAsDataURL(file);
        }

        // Initialize face detection (simplified version)
        function initializeFaceDetection() {
            faceDetectionEnabled = true;
            updateStatus('‚úÖ Face detection initialized - ready for real-time swap');
        }

        // Enhanced face detection using basic image processing
        function detectFaces(imageData) {
            const faces = [];
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;

            // Simple skin tone detection for face area estimation
            let skinPixels = 0;
            let totalPixels = 0;
            let avgX = 0, avgY = 0;

            // Scan image for skin-tone pixels (simplified)
            for (let y = Math.floor(height * 0.2); y < height * 0.8; y += 4) {
                for (let x = Math.floor(width * 0.2); x < width * 0.8; x += 4) {
                    const i = (y * width + x) * 4;
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    // Simple skin tone detection
                    if (r > 95 && g > 40 && b > 20 &&
                        r > g && r > b &&
                        Math.abs(r - g) > 15) {
                        skinPixels++;
                        avgX += x;
                        avgY += y;
                    }
                    totalPixels++;
                }
            }

            // If enough skin pixels found, estimate face location
            if (skinPixels > totalPixels * 0.02) { // At least 2% skin pixels
                avgX /= skinPixels;
                avgY /= skinPixels;

                const faceWidth = Math.min(150, width * 0.25);
                const faceHeight = Math.min(180, height * 0.35);

                faces.push({
                    x: avgX - faceWidth / 2,
                    y: avgY - faceHeight / 2,
                    width: faceWidth,
                    height: faceHeight,
                    confidence: Math.min(0.95, skinPixels / (totalPixels * 0.05))
                });
            } else {
                // Fallback to center detection
                const faceWidth = 120;
                const faceHeight = 150;
                faces.push({
                    x: width / 2 - faceWidth / 2,
                    y: height / 2 - faceHeight / 2,
                    width: faceWidth,
                    height: faceHeight,
                    confidence: 0.6
                });
            }

            return faces;
        }

        // Blend target face onto detected face area
        function blendFaceOntoCanvas(face) {
            if (!targetFaceImg) return;

            // Save current context
            ctx.save();

            // Create circular clipping mask for more natural blending
            ctx.beginPath();
            ctx.ellipse(
                face.x + face.width / 2,
                face.y + face.height / 2,
                face.width / 2,
                face.height / 2,
                0, 0, 2 * Math.PI
            );
            ctx.clip();

            // Set blend mode for more natural face swapping
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 0.8; // Semi-transparent for blending

            // Draw target face scaled to detected face size
            ctx.drawImage(
                targetFaceImg,
                face.x,
                face.y,
                face.width,
                face.height
            );

            // Restore context
            ctx.restore();

            // Draw face detection rectangle (optional, for debugging)
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.strokeRect(face.x, face.y, face.width, face.height);
        }

        function updateStatus(message) {
            document.getElementById('status-display').textContent = message;
        }

        // Real-time face swap functions
        async function startFaceSwap() {
            if (!cameraStream) {
                alert('Please start the camera first');
                return;
            }

            if (!targetFaceImage) {
                alert('Please upload a target face image first');
                return;
            }

            faceSwapActive = true;
            updateStatus('üé≠ Starting real-time face swap...');

            try {
                // Check MCP backend connection
                const healthCheck = await fetch('/api/mcp/status');
                if (!healthCheck.ok) {
                    throw new Error('MCP backend not available');
                }

                updateStatus('‚úÖ Real-time face swap active');
                processVideoFrame();

            } catch (error) {
                console.error('Face swap error:', error);
                updateStatus('‚ö†Ô∏è Demo mode - MCP backend unavailable');
                processDemoVideoFrame();
            }
        }

        function stopFaceSwap() {
            faceSwapActive = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            updateStatus('‚èπÔ∏è Face swap stopped');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Real-time face swap will appear here', canvas.width / 2, canvas.height / 2);
        }

        function processVideoFrame() {
            if (!faceSwapActive) return;

            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Perform face detection and swapping if target face is loaded
            if (targetFaceImg && faceDetectionEnabled) {
                // Get image data for face detection
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // Detect faces in current frame
                detectedFaces = detectFaces(imageData);

                // Swap faces for each detected face
                detectedFaces.forEach(face => {
                    if (face.confidence > 0.5) { // Only swap if confidence is high enough
                        blendFaceOntoCanvas(face);
                    }
                });

                // Add processing info
                ctx.fillStyle = '#00ff00';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(`üé≠ Faces detected: ${detectedFaces.length}`, 10, 25);
                ctx.fillText(`Target: Loaded (${Math.round(targetFaceImg.width)}x${Math.round(targetFaceImg.height)})`, 10, 40);

                if (detectedFaces.length > 0) {
                    ctx.fillText(`Confidence: ${Math.round(detectedFaces[0].confidence * 100)}%`, 10, 55);
                }
            } else {
                // Show status when no target face
                ctx.fillStyle = '#ff9800';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('‚ö†Ô∏è Upload target face to enable swapping', 10, 25);
            }

            animationFrame = requestAnimationFrame(processVideoFrame);
        }

        function processDemoVideoFrame() {
            if (!faceSwapActive) return;

            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Simulate face swapping in demo mode
            if (targetFaceImg) {
                // Simulate face detection with animated rectangle
                const time = Date.now() / 1000;
                const faceX = canvas.width / 2 - 60 + Math.sin(time) * 10;
                const faceY = canvas.height / 2 - 75 + Math.cos(time * 0.5) * 5;
                const faceWidth = 120;
                const faceHeight = 150;

                // Draw simulated face swap
                ctx.save();
                ctx.globalAlpha = 0.7;
                ctx.drawImage(targetFaceImg, faceX, faceY, faceWidth, faceHeight);
                ctx.restore();

                // Draw detection rectangle
                ctx.strokeStyle = '#ffc107';
                ctx.lineWidth = 2;
                ctx.strokeRect(faceX, faceY, faceWidth, faceHeight);

                // Add demo indicators
                ctx.fillStyle = '#ffc107';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('‚ö†Ô∏è DEMO MODE - Simulated face swap', 10, 25);
                ctx.fillText('Connect MCP backend for real AI processing', 10, 40);
                ctx.fillText(`Face confidence: ${Math.round(85 + Math.sin(time * 2) * 10)}%`, 10, 55);
            } else {
                // Demo mode without target face
                ctx.fillStyle = 'rgba(255, 193, 7, 0.2)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#ffc107';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚ö†Ô∏è DEMO MODE', canvas.width / 2, canvas.height / 2 - 20);
                ctx.font = '12px Arial';
                ctx.fillText('Upload target face to see demo face swap', canvas.width / 2, canvas.height / 2);
                ctx.fillText('Connect MCP backend for real AI processing', canvas.width / 2, canvas.height / 2 + 20);
            }

            animationFrame = requestAnimationFrame(processDemoVideoFrame);
        }

        function downloadResult() {
            alert('üíæ Download feature available in full version');
        }

        function resetAll() {
            stopFaceSwap();
            stopCamera();
            targetFaceImage = null;
            document.getElementById('target-preview').innerHTML = '';

            // Reset canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Real-time face swap will appear here', canvas.width / 2, canvas.height / 2);

            updateStatus('Ready for real-time face swap');
        }

        console.log('‚úÖ Face Swap Studio Ready!');
    </script>
</body>

</html>